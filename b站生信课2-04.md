<a id="mulu">目录</a>
<a href="#mulu" class="back">回到目录</a>
<style>
    .back{width:40px;height:40px;display:inline-block;line-height:20px;font-size:20px;background-color:lightyellow;position: fixed;bottom:50px;right:50px;z-index:999;border:2px solid pink;opacity:0.3;transition:all 0.3s;color:green;}
    .back:hover{color:red;opacity:1}
    img{vertical-align:bottom;}
</style>

<!-- @import "[TOC]" {cmd="toc" depthFrom=3 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [免疫组化图片](#免疫组化图片)
- [免疫细胞浸润分析(cibersort)](#免疫细胞浸润分析cibersort)

<!-- /code_chunk_output -->

<!-- 打开侧边预览：f1->Markdown Preview Enhanced: open...
只有打开侧边预览时保存才自动更新目录 -->

写在前面：本篇教程来自b站课程[TCGA及GEO数据挖掘入门必看](https://www.bilibili.com/video/BV1b34y1g7RM) P22-P26

### 免疫组化图片
使用HPA数据库，它是基于蛋白质组学、转录组学以及系统生物学数据创建的，拥有组织、细胞、器官等图谱，不仅收录肿瘤组织，也涵盖正常组织的蛋白表达情况，还可查询肿瘤患者的生存曲线
以EGFR基因为例：进入[HPA官网](https://www.proteinatlas.org)，在搜索栏中输入`EGFR`，search
- `Tissue`是正常组织
- `Pathology`是肿瘤组织

![免疫组化图片1](./md-image/免疫组化图片1.png){:width=200 height=200}
点击[tissue的那张图](https://www.proteinatlas.org/ENSG00000146648-EGFR/tissue)
- `RNA expression (nTPM)`是RNA表达水平
- `Protein expression (score)`是蛋白表达水平

![免疫组化图片2](./md-image/免疫组化图片2.png){:width=250 height=250}
点击`Respiratory system`->`Lung`，就可以查看该基因[在肺中的表达](https://www.proteinatlas.org/ENSG00000146648-EGFR/tissue/lung)
`Antibody HPA001200`、`Antibody HPA018530`、...这些都是抗体名称
以`HPA018530`为例，点击[对应的图片](https://images.proteinatlas.org/18530/41191_A_2_4.jpg)
![免疫组化图片4](./md-image/免疫组化图片4.png){:width=250 height=250}

---

对于[肿瘤组织](https://www.proteinatlas.org/ENSG00000146648-EGFR/pathology)，点击页面下方的`Lung cancer`就可查看该基因[在肺癌中的表达](https://www.proteinatlas.org/ENSG00000146648-EGFR/pathology/lung+cancer#ihc)
![免疫组化图片3](./md-image/免疫组化图片3.png){:width=150 height=150}
在新打开的页面中，`Antibody staining`标识了各抗体的免疫组化图片，点击`HPA018530`，勾选`high`（高表达），点击[绿框标注的图片](https://images.proteinatlas.org/18530/41189_B_1_3.jpg)
![免疫组化图片5](./md-image/免疫组化图片5.png){:width=250 height=250}
对比这两种图片，就可得到该抗体在正常/肿瘤免疫组化的结果
![免疫组化图片6](./md-image/免疫组化图片6.png){:width=250 height=250}
### 免疫细胞浸润分析(cibersort)
需要数据：tpm表达矩阵
需要包：`e1071`、`parallel`、`preprocessCore`、`bseqsc`、`tidyverse`、`corrplot`、`vioplot`、`CIBERSORT`
```{r}
if(!require("e1071", quietly = T))
{
  install.packages("e1071");
}
if(!require("parallel", quietly = T))
{
  install.packages("parallel");
}
if(!require("preprocessCore", quietly = T))
{
  library(BiocManager);
  BiocManager::install("preprocessCore");
}
if(!require("devtools", quietly = T))
{
  install.packages("devtools");
}
if(!require("corrplot", quietly = T))
{
  install.packages("corrplot");
}
if(!require("vioplot", quietly = T))
{
  install.packages("vioplot");
}
if(!require("bseqsc", quietly = T))
{
  library(devtools);
  devtools::install_github("shenorrlab/bseqsc");
}
if(!require("CIBERSORT", quietly = T))
{
  library(devtools);
  devtools::install_github("Moonerss/CIBERSORT");
}
library(devtools);
library(e1071);
library(preprocessCore);
library(parallel);
library(bseqsc);
library(ggplot2);
library(CIBERSORT);
library(corrplot);
library(vioplot);
```
**读取数据**：
```{r}
data(LM22);  # 导入CIBERSORT内置数据，包含22种细胞中基因表达情况
data <- read.table("C:\\Users\\WangTianHao\\Documents\\GitHub\\R-for-bioinformatics\\b站生信课03\\save_data\\TCGA_LUSC_TPM.txt", check.names = F, row.names = 1, sep = '\t', header = T);
dimnames <- list(rownames(data), colnames(data));
data <- matrix(as.numeric(as.matrix(data)), nrow = nrow(data), dimnames = dimnames);
```
**进行CIBERSORT分析**：
```{r}
res <- cibersort(sig_matrix = LM22, mixture_file = data);
# 保存结果
res <- as.matrix(res[, 1:(ncol(res)-3)]);
res_save <- cbind(id = rownames(res), res);
write.table(res_save, file = "C:\\Users\\WangTianHao\\Documents\\GitHub\\R-for-bioinformatics\\b站生信课03\\save_data\\CIBERSORT-Results.txt", row.names = F, sep = '\t', quote = F);
```
![免疫细胞浸润分析1](./md-image/免疫细胞浸润分析1.png){:width=200 height=200}
行名是样本名，列名是不同的细胞类型，后三列是p值、相关性、RMSE，这三列一般不用，删去
**绘图--柱状图1**：
```{r}
immune <- read.table("C:\\Users\\WangTianHao\\Documents\\GitHub\\R-for-bioinformatics\\b站生信课03\\save_data\\CIBERSORT-Results.txt", header = T, sep = '\t', check.names = F);
library(tidyverse);
immune <- column_to_rownames(immune, "id");
immune <- as.matrix(immune);
data <- t(immune);
col <- rainbow(nrow(data), s = 0.7, v = 0.7);
pdf(file = "C:\\Users\\WangTianHao\\Documents\\GitHub\\R-for-bioinformatics\\b站生信课03\\save_data\\CIBERSORT1.pdf", width = 22, height = 10);
par(las = 1, mar = c(8, 5, 4, 16), mgp = c(3, 0.1, 0), cex.axis = 1.5);
a1 <- barplot(data, col = col, yaxt = "n", ylab = "Relative Percent", xaxt = "n", cex.lab = 1.8);
a2 <- axis(2, tick = F, labels = F);
axis(2, a2, paste0(a2*100, "%"));
axis(1, a1, labels = F);
par(srt = 60, xpd = T);
text(a1, -0.02, colnames(data), adj = 1, cex = 0.6);
par(srt = 0);
ytick2 <- cumsum(data[, ncol(data)]);
ytick1 <- c(0, ytick2[-length(ytick2)]);
legend(
  par("usr")[2]*0.98,
  par("usr")[4],
  legend = rownames(data),
  col = col, pch = 15, bty = "n", cex = 1.3
);
dev.off();
```
![免疫细胞浸润分析2](./md-image/免疫细胞浸润分析2.png){:width=400 height=400}
颜色代表细胞类型，横坐标是不同的样本，纵坐标是不同类型的细胞在不同样本中所占的比例
**第二种柱状图**：
```{r}
cell.prop <- apply(data, 1, function(x){x/sum(x)});
my_colors36 <- c('#E5D2DD','#476D87','#585658','#F7F398','#B53E2B','#3A6963','#53A85F','#E95C59','#9FA3A8','#AA9A59','#712820','#968175','#F1BB72','#E0D4CA','#E63863','#DCC1DD','#F3B1A0','#AB3282','#5F3D69','#E39A35','#CCE0F5','#D6E7A3','#23452F','#C5DEBA','#C1E6F3','#CCC9E6','#57C3F3','#BD956A','#58A4C3','#6778AE','#625D9E','#8C549C','#E4C755','#91D0BE','#68A180');
plot_data <- data.frame();
for(i in 1:ncol(cel)){
  
}
```
